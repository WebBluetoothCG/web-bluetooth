language: python
python: 3.7
addons:
  apt:
    packages:
    - python-pip

install:
- git clone --depth=1 https://github.com/tabatkins/bikeshed.git
- pip install --editable bikeshed
- bikeshed update

env:
  global:
  - SPECS="index scanning tests use-cases"
  - COLOR_RED="\e[31m"
  - COLOR_DEFAULT="\e[39m"

script:
- mkdir -p out
- for SPEC in $SPECS; do
-   echo "Parsing ${SPEC}.bs:"
-   ERR=$(bikeshed --die-on=warning spec ${SPEC}.bs out/{SPEC}.html)
-   if [ -n "$ERR" ]; then
-     echo -e "Error occurred while parsing ${SPEC}.bs:${COLOR_DEFAULT}"
-     echo -e "$ERR"
-     exit 1
-   fi
- done
- # Keep links to gh-pages/implementation-status.md working.
- cp -r implementation-status.md out/

branches:
  only:
  - master

deploy:
  provider: pages:git
  local_dir: out
  deploy_key: deploy_key.gpg
  on:
    branch: master
  edge: true

notifications:
  email:
    on_success: never
    on_failure: always
